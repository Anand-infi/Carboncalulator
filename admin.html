<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f6f9; margin: 20px; }
    h2 { color: #333; }
    .card { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    input, button, select { margin: 5px 0; padding: 8px; width: 100%; }
    button { background: #007bff; color: white; border: none; cursor: pointer; border-radius: 4px; }
    button:hover { background: #0056b3; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #eaeaea; }
  </style>
</head>
<body>
  <h2>ðŸŒ¿ Admin Dashboard</h2>

  <!-- Section 1: Add New Category -->
  <div class="card">
    <h3>Add New Emission Category</h3>
    <input type="text" id="categoryName" placeholder="Category name (e.g., Transport)" />
    <input type="number" id="emissionFactor" placeholder="Emission factor (e.g., 2.31)" />
    <button id="addCategory">Add Category</button>
    <p id="catMsg"></p>
  </div>

  <!-- Section 2: Assign Categories to Users -->
  <div class="card">
    <h3>Assign Categories to Users</h3>
    <select id="userSelect"><option>Loading users...</option></select>
    <select id="categoryAssign"><option>Loading categories...</option></select>
    <button id="assignCatBtn">Assign Category</button>
    <p id="assignMsg"></p>
  </div>

  <!-- Section 3: View Submitted Emission Data -->
  <div class="card">
    <h3>All Submitted Data</h3>
    <table id="dataTable">
      <thead>
        <tr>
          <th>User Email</th>
          <th>Category</th>
          <th>Activity Value</th>
          <th>Factor</th>
          <th>Total Emission</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
    import { 
      getFirestore, collection, addDoc, getDocs, updateDoc, doc, getDoc, query, where, onSnapshot, arrayUnion 
    } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

    // ðŸ”§ CONFIGURATION
    const firebaseConfig = {
	  apiKey: "AIzaSyDCyXTdzGqevLfj754uaU-6jrEiXnUx_mQ",
	  authDomain: "carbon-calculator-infinite.firebaseapp.com",
	  projectId: "carbon-calculator-infinite",
	  storageBucket: "carbon-calculator-infinite.firebasestorage.app",
	  messagingSenderId: "1029287920151",
	  appId: "1:1029287920151:web:7a9e0cf0f4eefce5385252"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const categoryName = document.getElementById("categoryName");
    const emissionFactor = document.getElementById("emissionFactor");
    const addCategoryBtn = document.getElementById("addCategory");
    const catMsg = document.getElementById("catMsg");

    const userSelect = document.getElementById("userSelect");
    const categoryAssign = document.getElementById("categoryAssign");
    const assignCatBtn = document.getElementById("assignCatBtn");
    const assignMsg = document.getElementById("assignMsg");
    const dataTable = document.querySelector("#dataTable tbody");

    let currentUser;
//new paragraph
	  const userSelect = document.getElementById("userSelect");
	const categoryCheckboxes = document.getElementById("categoryCheckboxes");
	const assignButton = document.getElementById("assignButton");
	const assignMsg = document.getElementById("assignMsg");

const usersRef = collection(db, "users");
const categoriesRef = collection(db, "categories");

// Load all normal users (role: "user") into dropdown
async function loadUsers() {
  const snapshot = await getDocs(usersRef);
  userSelect.innerHTML = "<option value=''>Select a user</option>";
  
  snapshot.forEach(docSnap => {
    const data = docSnap.data();
    if (data.role === "user") {
      const option = document.createElement("option");
      option.value = docSnap.id; // UID
      option.textContent = data.email || docSnap.id;
      userSelect.appendChild(option);
    }
  });
}

// Load categories as checkboxes
async function loadCategories() {
  const snapshot = await getDocs(categoriesRef);
  categoryCheckboxes.innerHTML = "";

  snapshot.forEach(docSnap => {
    const data = docSnap.data();
    const label = document.createElement("label");
    label.innerHTML = `
      <input type="checkbox" value="${data.name}"> ${data.name}<br>
    `;
    categoryCheckboxes.appendChild(label);
  });
}

// Call these functions on page load
loadUsers();
loadCategories();

//till here
	  
    // Auth check
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }

      currentUser = user;
      const userDoc = await getDoc(doc(db, "users", user.uid));

      if (!userDoc.exists() || userDoc.data().role !== "admin") {
        alert("Access denied. You are not an admin.");
        window.location.href = "dashboard.html";
        return;
      }

      loadCategories();
      loadUsers();
      loadEmissionData();
    });

    // Add new category
    addCategoryBtn.addEventListener("click", async () => {
      const name = categoryName.value.trim();
      const factor = parseFloat(emissionFactor.value);

      if (!name || isNaN(factor)) {
        catMsg.textContent = "Please enter valid details.";
        return;
      }

      await addDoc(collection(db, "categories"), {
        name,
        factor,
        createdBy: currentUser.email
      });

      catMsg.textContent = `âœ… Category '${name}' added successfully!`;
      categoryName.value = "";
      emissionFactor.value = "";
      loadCategories();
    });

    // Load categories into dropdowns
    async function loadCategories() {
      const snapshot = await getDocs(collection(db, "categories"));
      categoryAssign.innerHTML = "<option value=''>-- Select Category --</option>";
      snapshot.forEach((docSnap) => {
        const data = docSnap.data();
        categoryAssign.innerHTML += `<option value="${data.name}">${data.name}</option>`;
      });
    }

    // Load users for assignment
    async function loadUsers() {
      const snapshot = await getDocs(collection(db, "users"));
      userSelect.innerHTML = "<option value=''>-- Select User --</option>";
      snapshot.forEach((docSnap) => {
        const data = docSnap.data();
        if (data.role === "user") {
          userSelect.innerHTML += `<option value="${docSnap.id}">${data.displayName || docSnap.id}</option>`;
        }
      });
    }

    // Assign category to user
    assignCatBtn.addEventListener("click", async () => {
      const userId = userSelect.value;
      const category = categoryAssign.value;
      if (!userId || !category) {
        assignMsg.textContent = "Select user and category first!";
        return;
      }
	

      const userRef = doc(db, "users", userId);
      await updateDoc(userRef, {
        assignedCategories: arrayUnion(category)

		  <h3>Assign Categories to Users</h3>
<select id="userSelect">
  <option value="">Select a user</option>
</select>
<div id="categoryCheckboxes"></div>
<button id="assignButton">Assign Categories</button>
<p id="assignMsg"></p>
      });
      assignMsg.textContent = `âœ… Assigned '${category}' to user successfully.`;
    });


	  

    // Live view of all submissions
    function loadEmissionData() {
      onSnapshot(collection(db, "emissions"), (snapshot) => {
        dataTable.innerHTML = "";
        snapshot.forEach((docSnap) => {
          const d = docSnap.data();
          const row = `<tr>
            <td>${d.userEmail}</td>
            <td>${d.category}</td>
            <td>${d.activityValue}</td>
            <td>${d.factor}</td>
            <td>${d.value.toFixed(2)}</td>
          </tr>`;
          dataTable.innerHTML += row;
        });
      });
    }
  </script>
</body>
</html>



