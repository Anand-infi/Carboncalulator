<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>User Dashboard</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js"></script>
  <style>
    body {
      font-family: Arial;
      background: #f6f7f8;
      padding: 20px;
    }
    form {
      background: white;
      padding: 15px;
      border-radius: 8px;
      width: 300px;
    }
    select, input, button {
      width: 100%;
      margin-top: 10px;
      padding: 8px;
    }
  </style>
</head>
<body>
  <h2>User Dashboard</h2>
  <form id="emissionForm">
    <label>Select Category:</label>
    <select id="categorySelect" required>
      <option value="">Loading categories...</option>
    </select>

    <label>Enter Activity Data (e.g., litres, kWh, kg):</label>
    <input type="number" id="activityValue" placeholder="Enter value" required />

    <button type="submit">Submit Data</button>
  </form>

  <h3>Your Submitted Data:</h3>
  <table border="1" id="dataTable" style="margin-top:10px; border-collapse: collapse;">
    <thead>
      <tr>
        <th>Category</th>
        <th>Activity</th>
        <th>Emission Factor</th>
        <th>Total Emissions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, serverTimestamp, onSnapshot } 
      from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

    const firebaseConfig = {
	  apiKey: "AIzaSyDCyXTdzGqevLfj754uaU-6jrEiXnUx_mQ",
	  authDomain: "carbon-calculator-infinite.firebaseapp.com",
	  projectId: "carbon-calculator-infinite",
	  storageBucket: "carbon-calculator-infinite.firebasestorage.app",
	  messagingSenderId: "1029287920151",
	  appId: "1:1029287920151:web:7a9e0cf0f4eefce5385252"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const categorySelect = document.getElementById("categorySelect");
    const emissionForm = document.getElementById("emissionForm");
    const dataTable = document.querySelector("#dataTable tbody");

    let categories = {};

    // Load categories
    async function loadCategories() {
      const snapshot = await getDocs(collection(db, "categories"));
      categorySelect.innerHTML = `<option value="">-- Select Category --</option>`;
      snapshot.forEach((doc) => {
        const data = doc.data();
        categories[data.name] = data.factor;
        categorySelect.innerHTML += `<option value="${data.name}">${data.name}</option>`;
      });
    }

    // Submit emission data
    emissionForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const category = categorySelect.value;
      const activityValue = parseFloat(document.getElementById("activityValue").value);
      const factor = categories[category] || 0;
      const total = activityValue * factor;
      const user = auth.currentUser;

      if (!user) return alert("Not logged in!");

      await addDoc(collection(db, "emissions"), {
        userEmail: user.email,
        category,
        value: total,
        factor,
        activityValue,
        createdAt: serverTimestamp()
      });

      alert("Data submitted successfully!");
      emissionForm.reset();
    });

    // Show live data
    onSnapshot(collection(db, "emissions"), (snapshot) => {
      dataTable.innerHTML = "";
      snapshot.forEach((doc) => {
        const d = doc.data();
        const row = `<tr>
          <td>${d.category}</td>
          <td>${d.activityValue}</td>
          <td>${d.factor}</td>
          <td>${d.value.toFixed(2)}</td>
        </tr>`;
        dataTable.innerHTML += row;
      });
    });

    // Auth check
    onAuthStateChanged(auth, (user) => {
      if (!user) window.location.href = "login.html";
      else loadCategories();
    });
  </script>
</body>
</html>
